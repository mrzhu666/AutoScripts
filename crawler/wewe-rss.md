## wewe-rss 自动化任务说明

### 脚本整体目标与作用

- **核心目标**：
  - 自动化操作 `http://desktop-wsl-tailscale:4000/dash` 仪表盘，
  - 完成**登录认证 → 读取左侧订阅列表 → 对每个订阅逐个执行“立即更新”并等待完成**的全流程，
  - 代替人工在页面上重复点击和等待，确保所有订阅源都被轮询更新一次。
- **主要作用**：
  - 批量触发 RSS/订阅源的刷新，减少人工维护成本。
  - 通过日志记录每一个订阅的处理情况（标题、data_key、是否更新成功），便于后续审计与排错。

### 适用场景

- 你已经在本机或局域网中部署了 `wewe-rss` 或类似仪表盘，并通过浏览器访问 `http://desktop-wsl-tailscale:4000/dash`。
- 仪表盘左侧存在一个订阅列表，右侧详情页中提供“立即更新”链接按钮，点击后会触发后台抓取/更新。
- 不希望每次手工点开每一个订阅再点“立即更新”，而是希望定期批量执行一次全量更新。

### 运行环境与前置条件

- **运行环境**：
  - Python 3.9+
  - 已安装 `selenium`，且本机可用对应版本的 Chrome / ChromeDriver。
- **前置条件**：
  - `crawler/wewe-rrs-cookie.txt` 中已写入可用的浏览器 cookie 字符串，用于免登录访问仪表盘。
  - 目标地址 `http://desktop-wsl-tailscale:4000/dash` 在当前机器上可访问。
  - 页面结构满足以下约定（当前代码基于这些选择器）：
    - 认证输入框：`input[aria-label="AuthCode"]`
    - 确认按钮：按钮文字为“确认”，`<button type="button">确认</button>`
    - 左侧订阅列表：`li[data-slot="base"] ul[role="group"] a[role="option"]`
    - 每个订阅项标题：内部 `span[data-label="true"]`
    - “立即更新”链接：`<a role="link" href="#">立即更新</a>`，状态变化为“更新中...”。

### 使用方式（如何运行脚本）

- 在项目根目录（`AutoScripts`）下执行：
  - `python -m crawler.wewe-rss` 或在 IDE 中直接运行 `wewe-rss.py`。
- 脚本执行后会：
  1. 自动启动 Chrome 浏览器并打开仪表盘页面。
  2. 自动注入 cookie、输入认证密钥并点击“确认”。
  3. 读取左侧订阅列表并依次处理每一个有效订阅项。
  4. 对每个订阅项重复执行5次"立即更新"操作，每次等待状态恢复为"立即更新"后再进行下一次，5次全部完成后再处理下一项。
  5. 最终在终端提示"按 Enter 键关闭浏览器..."，此时可以在浏览器中人工检查结果，然后回车关闭。

下面是根据当前实现代码整理的实际任务拆分（已按“最小可快速验证”原则落地）。

### 任务1：打开仪表盘页面

- **目标**：启动 Chrome WebDriver，并打开 `http://desktop-wsl-tailscale:4000/dash`，等待页面加载完成。
- **实现**：
  - 使用 `create_webdriver` 创建浏览器实例，配置基础选项。
  - 使用 `navigate_to_page` 打开目标 URL，并通过 `document.readyState == 'complete'` 判定加载完成。
- **验证方式**：
  - 日志中出现“页面加载成功: ...”。
  - 无 `TimeoutException` / `WebDriverException` 相关错误日志。

### 任务2：设置 Cookie 并输入认证密钥

- **目标**：将本地 cookie 文件注入浏览器，并在页面中输入认证密钥 `123567`。
- **实现**：
  - 使用 `load_cookies_from_file` 从 `wewe-rrs-cookie.txt` 读取浏览器 cookie 字符串并解析为字典列表。
  - 使用 `set_cookies_from_file` 在访问根域名后注入 cookie，再回到原页面。
  - 使用 `enter_auth_code` 通过 `input[aria-label="AuthCode"]` 定位输入框，清空并输入密钥，然后读取 `value` 校验。
- **验证方式**：
  - 日志中打印“成功解析 X 个 cookie”“已返回原页面并应用 cookie”。
  - 日志中打印“密钥输入成功并通过校验”，否则会有明确的 warning。

### 任务3：点击“确认”按钮完成登录/认证

- **目标**：在输入密钥后，点击页面上的“确认”按钮，触发后端对密钥的处理与页面状态切换。
- **实现**：
  - 使用 `click_auth_confirm_button` 通过 XPATH `//button[@type="button" and normalize-space(text())="确认"]` 定位按钮。
  - 等待按钮可点击后执行点击。
- **验证方式**：
  - 日志中出现“已点击‘确认’按钮”。
  - 如点击失败会有超时或 WebDriver 错误的日志。

### 任务4：读取左侧订阅列表（动态长度）

- **目标**：读取左侧订阅列表中当前所有可见订阅项（不关心具体数量，随页面动态变化）。
- **实现**：
  - 使用 `read_left_feed_list`，通过选择器 `li[data-slot="base"] ul[role="group"] a[role="option"]` 获取所有列表项。
  - 对每个 `a[role="option"]`：
    - 读取内部 `span[data-label="true"]` 的文字作为 `title`。
    - 读取 `href` 和 `data-key`。
  - 使用 `FeedItem` dataclass 存储为结构化数据列表。
- **验证方式**：
  - 日志中打印“成功读取左侧订阅列表，共 N 项”。
  - 前几条订阅项（标题、data_key、href）会写入日志方便人工检查。

### 任务5：依次点击左侧订阅列表的每一项（跳过“全部”）

- **目标**：循环点击左侧列表中的每个实际订阅项，用于后续触发更新。
- **实现**：
  - 使用 `click_all_feed_items`，每次循环前重新通过同一选择器获取最新元素列表，避免 `StaleElementReference`。
  - 第一项通常为“全部”，不对应具体订阅，按照以下规则跳过：
    - `index == 0` 或
    - 列表项标题文本为 `"全部"`。
  - 对其余每个订阅项：
    - 滚动至可视区域。
    - 等待可点击后执行点击。
- **验证方式**：
  - 日志中：
    - 对首项或标题为“全部”的项，打印“跳过第 X 项无效订阅项”。
    - 对有效订阅项，打印“处理第 X 项订阅: title='...', data_key='...'”。
  - 最后打印“列表项点击完成，共成功点击 X/Y 项”。

### 任务6：对每个订阅项执行"立即更新"并等待完成（重复5次）

- **目标**：在点击每个有效订阅项后，重复执行5次"立即更新"按钮点击操作，每次等待后端处理完成（文本从"立即更新"→"更新中..."→"立即更新"）。
- **实现**：
  - 在 `click_all_feed_items` 的每次有效点击后，调用 `click_update_link_and_wait`（默认重复次数为5）：
    - 循环执行5次完整的更新流程，每次流程包括：
      - 使用 XPATH `//a[@role="link" and @href="#" and normalize-space(text())="立即更新"]` 定位"立即更新"链接。
      - 点击后，等待出现 `text == "更新中..."` 的同一链接。
      - 再等待文本恢复为"立即更新"，且元素重新可点击，表示本次更新完成。
    - 每次循环完成后记录成功或失败，最终统计所有5次的执行结果。
  - 若5次更新流程全部成功，当前项计入成功计数；否则记录 warning，但继续处理下一项。
- **验证方式**：
  - 每次更新过程都会在日志中输出循环次数和三个步骤：
    - "开始第 X/5 次'立即更新'流程"
    - "开始查找并点击'立即更新'按钮"
    - "等待'立即更新'按钮进入'更新中...'状态"
    - "等待更新完成，'更新中...'恢复为'立即更新'"
    - "第 X/5 次'立即更新'流程完成"
  - 最终会输出统计信息："所有 5 次'立即更新'流程均成功完成"或"5 次'立即更新'流程执行完成：成功 X 次，失败 Y 次"
  - 若超时或发生异常，会有清晰的 warning 日志，便于排查。

### 任务7：整体流程串联与人工确认

- **目标**：将上述所有步骤串联成完整自动化脚本，便于一键运行与快速验证。
- **实现**（`main` 函数）：
  1. 创建 WebDriver，打开仪表盘页面（任务1）。
  2. 注入 cookie（任务2 上半部分）。
  3. 输入认证密钥（任务2 下半部分）。
  4. 点击“确认”按钮（任务3）。
  5. 读取左侧订阅列表（任务4）。
  6. 依次点击每个有效订阅项，并对每一项重复执行5次"立即更新"并等待完成（任务5 + 任务6）。
  7. 整个流程结束后，等待用户按 Enter 再关闭浏览器，便于人工在页面上检查实际效果。
- **验证方式**：
  - 终端日志应依次出现上述任务对应的关键日志信息。
  - 页面侧可看到：每个订阅项被依次选中，对每个订阅项"立即更新"按钮会重复5次在"立即更新"与"更新中..."之间切换。
