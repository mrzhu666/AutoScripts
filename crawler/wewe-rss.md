## wewe-rss 自动化任务说明

本脚本使用 Selenium 自动化操作 `http://desktop-wsl-tailscale:4000/dash`，完成从打开页面、认证、读取订阅列表到逐项更新的完整流程。下面是根据当前实现代码整理的实际任务拆分（已按“最小可快速验证”原则落地）。

### 任务1：打开仪表盘页面

- **目标**：启动 Chrome WebDriver，并打开 `http://desktop-wsl-tailscale:4000/dash`，等待页面加载完成。
- **实现**：
  - 使用 `create_webdriver` 创建浏览器实例，配置基础选项。
  - 使用 `navigate_to_page` 打开目标 URL，并通过 `document.readyState == 'complete'` 判定加载完成。
- **验证方式**：
  - 日志中出现“页面加载成功: ...”。
  - 无 `TimeoutException` / `WebDriverException` 相关错误日志。

### 任务2：设置 Cookie 并输入认证密钥

- **目标**：将本地 cookie 文件注入浏览器，并在页面中输入认证密钥 `123567`。
- **实现**：
  - 使用 `load_cookies_from_file` 从 `wewe-rrs-cookie.txt` 读取浏览器 cookie 字符串并解析为字典列表。
  - 使用 `set_cookies_from_file` 在访问根域名后注入 cookie，再回到原页面。
  - 使用 `enter_auth_code` 通过 `input[aria-label="AuthCode"]` 定位输入框，清空并输入密钥，然后读取 `value` 校验。
- **验证方式**：
  - 日志中打印“成功解析 X 个 cookie”“已返回原页面并应用 cookie”。
  - 日志中打印“密钥输入成功并通过校验”，否则会有明确的 warning。

### 任务3：点击“确认”按钮完成登录/认证

- **目标**：在输入密钥后，点击页面上的“确认”按钮，触发后端对密钥的处理与页面状态切换。
- **实现**：
  - 使用 `click_auth_confirm_button` 通过 XPATH `//button[@type="button" and normalize-space(text())="确认"]` 定位按钮。
  - 等待按钮可点击后执行点击。
- **验证方式**：
  - 日志中出现“已点击‘确认’按钮”。
  - 如点击失败会有超时或 WebDriver 错误的日志。

### 任务4：读取左侧订阅列表（动态长度）

- **目标**：读取左侧订阅列表中当前所有可见订阅项（不关心具体数量，随页面动态变化）。
- **实现**：
  - 使用 `read_left_feed_list`，通过选择器 `li[data-slot="base"] ul[role="group"] a[role="option"]` 获取所有列表项。
  - 对每个 `a[role="option"]`：
    - 读取内部 `span[data-label="true"]` 的文字作为 `title`。
    - 读取 `href` 和 `data-key`。
  - 使用 `FeedItem` dataclass 存储为结构化数据列表。
- **验证方式**：
  - 日志中打印“成功读取左侧订阅列表，共 N 项”。
  - 前几条订阅项（标题、data_key、href）会写入日志方便人工检查。

### 任务5：依次点击左侧订阅列表的每一项（跳过“全部”）

- **目标**：循环点击左侧列表中的每个实际订阅项，用于后续触发更新。
- **实现**：
  - 使用 `click_all_feed_items`，每次循环前重新通过同一选择器获取最新元素列表，避免 `StaleElementReference`。
  - 第一项通常为“全部”，不对应具体订阅，按照以下规则跳过：
    - `index == 0` 或
    - 列表项标题文本为 `"全部"`。
  - 对其余每个订阅项：
    - 滚动至可视区域。
    - 等待可点击后执行点击。
- **验证方式**：
  - 日志中：
    - 对首项或标题为“全部”的项，打印“跳过第 X 项无效订阅项”。
    - 对有效订阅项，打印“处理第 X 项订阅: title='...', data_key='...'”。
  - 最后打印“列表项点击完成，共成功点击 X/Y 项”。

### 任务6：对每个订阅项执行“立即更新”并等待完成

- **目标**：在点击每个有效订阅项后，点击“立即更新”按钮，并等待后端处理完成（文本从“立即更新”→“更新中...”→“立即更新”）。
- **实现**：
  - 在 `click_all_feed_items` 的每次有效点击后，调用 `click_update_link_and_wait`：
    - 使用 XPATH `//a[@role="link" and @href="#" and normalize-space(text())="立即更新"]` 定位“立即更新”链接。
    - 点击后，等待出现 `text == "更新中..."` 的同一链接。
    - 再等待文本恢复为“立即更新”，且元素重新可点击，表示本次更新完成。
  - 若更新流程成功，当前项计入成功计数；失败则记录 warning，但继续处理下一项。
- **验证方式**：
  - 每次更新过程都会在日志中输出三步：
    - “开始查找并点击‘立即更新’按钮”
    - “等待‘立即更新’按钮进入‘更新中...’状态”
    - “等待更新完成，‘更新中...’恢复为‘立即更新’”
  - 若超时或发生异常，会有清晰的 warning 日志，便于排查。

### 任务7：整体流程串联与人工确认

- **目标**：将上述所有步骤串联成完整自动化脚本，便于一键运行与快速验证。
- **实现**（`main` 函数）：
  1. 创建 WebDriver，打开仪表盘页面（任务1）。
  2. 注入 cookie（任务2 上半部分）。
  3. 输入认证密钥（任务2 下半部分）。
  4. 点击“确认”按钮（任务3）。
  5. 读取左侧订阅列表（任务4）。
  6. 依次点击每个有效订阅项，并对每一项执行一次“立即更新”并等待完成（任务5 + 任务6）。
  7. 整个流程结束后，等待用户按 Enter 再关闭浏览器，便于人工在页面上检查实际效果。
- **验证方式**：
  - 终端日志应依次出现上述任务对应的关键日志信息。
  - 页面侧可看到：每个订阅项被依次选中，“立即更新”按钮反复在“立即更新”与“更新中...”之间切换。
